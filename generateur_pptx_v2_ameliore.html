<!-- 
  ============================================
  GÃ©nÃ©rateur PowerPoint Professionnel v2.0
  Version amÃ©liorÃ©e avec correctifs intÃ©grÃ©s
  Date: 2025-10-24
  
  AmÃ©liorations v2.0:
  - Loader PptxGenJS robuste avec fallback
  - Validation tables 7 niveaux
  - Normalisation sÃ©curisÃ©e des donnÃ©es
  - GÃ©nÃ©ration progressive avec feedback
  - Gestion avancÃ©e des erreurs
  - Support des cas limites
  ============================================
-->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GÃ©nÃ©rateur PowerPoint Professionnel v2.0 (AmÃ©liorÃ©)</title>
  <script id="pptxgen-bundle-data" type="application/octet-stream"><!--PPTX_BUNDLE_BASE64--></script>
  <script type="text/plain" id="optimalPromptV2">
Tu es un gÃ©nÃ©rateur de contenu pour prÃ©sentations PowerPoint professionnelles. Tu dois produire UNIQUEMENT un objet JSON valide, sans texte avant/aprÃ¨s, sans balises markdown, sans commentaires.



â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
VERSION 2.0 - AMÃ‰LIORATIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Cette version intÃ¨gre les correctifs suivants :
â€¢ Validation renforcÃ©e des tables (7 niveaux de vÃ©rification)
â€¢ Normalisation sÃ©curisÃ©e avec gestion d'erreurs
â€¢ Feedback progressif pendant la gÃ©nÃ©ration
â€¢ Meilleure gestion des cas limites et erreurs
â€¢ Support amÃ©liorÃ© des caractÃ¨res spÃ©ciaux

CONTEXTE DE GÃ‰NÃ‰RATION (Ã  remplir) :
SUJET : [votre sujet]
AUDIENCE : [votre audience cible]
NOMBRE_SLIDES : [nombre exact de slides souhaitÃ©]
DURÃ‰E_MINUTES : [durÃ©e prÃ©vue de prÃ©sentation]
STYLE : [professionnel/crÃ©atif/acadÃ©mique/commercial]

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
CONTRAINTES TECHNIQUES ABSOLUES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“Œ ENCODAGE & SYNTAXE JSON
â€¢ UTF-8 obligatoire, accents franÃ§ais autorisÃ©s (Ã©, Ã¨, Ã , Ã§, Å“)
â€¢ Guillemets doubles UNIQUEMENT pour les clÃ©s et valeurs
â€¢ Pour insÃ©rer un guillemet double dans une chaÃ®ne : "
â€¢ INTERDICTION STRICTE : virgules finales dans objets/tableaux
â€¢ INTERDICTION STRICTE : commentaires // ou /* */
â€¢ Respect absolu du schÃ©ma JSON fourni ci-dessous

ğŸ“Œ CAS SPÃ‰CIAUX Ã€ GÃ‰RER IMPÃ‰RATIVEMENT

1ï¸âƒ£ GUILLEMETS DANS LE TEXTE
   âœ… CORRECT : 
      "bullets": ["Le concept \"innovation\" transforme les entreprises"]
   
   âŒ INCORRECT : 
      "bullets": ["Le concept "innovation" transforme les entreprises"]
      "bullets": ["Le concept Â«innovationÂ» transforme les entreprises"]
   
   RÃˆGLE : Toujours Ã©chapper les guillemets doubles internes avec \"
           Ne JAMAIS utiliser les guillemets typographiques Â« Â» " "

2ï¸âƒ£ NOMBRES DANS LES TABLEAUX
   âœ… CORRECT (chaÃ®nes de caractÃ¨res) :
      "tableData": [
        ["MÃ©trique", "Valeur", "Ã‰volution"],
        ["Croissance", "45%", "+12%"],
        ["Budget", "2.5Mâ‚¬", "Stable"]
      ]
   
   âŒ INCORRECT (nombres bruts) :
      "tableData": [
        ["MÃ©trique", "Valeur", "Ã‰volution"],
        ["Croissance", 45, 12],
        ["Budget", 2500000, 0]
      ]
   
   RÃˆGLE : TOUJOURS convertir nombres en chaÃ®nes avec unitÃ©s/formatage
           Exemple : 45 â†’ "45%", 2500000 â†’ "2.5Mâ‚¬", 3.7 â†’ "3.7/5"

3ï¸âƒ£ CARACTÃˆRES SPÃ‰CIAUX AUTORISÃ‰S
   âœ… AUTORISÃ‰S :
      â€¢ Accents : Ã  Ã© Ã¨ Ãª Ã§ Ã¹ Ã® Ã´ Ã» Ã« Ã¯
      â€¢ Ligatures : Å“ Ã¦
      â€¢ Apostrophes simples : '
      â€¢ Tirets : - (trait d'union), â€” (tiret cadratin pour emphase)
      â€¢ Symboles courants : â‚¬ $ % & @ # *
   
   âŒ INTERDITS :
      â€¢ Guillemets typographiques : Â« Â» " " ' '
      â€¢ CaractÃ¨res de contrÃ´le : \n \t \r (sauf Ã©chappement volontaire)
      â€¢ Emojis dans les donnÃ©es structurÃ©es (OK dans title/subtitle)
   
   RÃˆGLE : Utiliser uniquement les caractÃ¨res du standard UTF-8
           Remplacer Â« texte Â» par "texte" ou \"texte\" selon contexte

4ï¸âƒ£ VALIDATION AVANT GÃ‰NÃ‰RATION
   Avant de retourner le JSON, VÃ‰RIFIER MENTALEMENT :
   
   â˜‘ JSON.parse(output) fonctionnerait sans erreur
   â˜‘ Aucun guillemet typographique prÃ©sent
   â˜‘ Tous les nombres dans tableData sont entre "guillemets"
   â˜‘ Aucune virgule finale : {"key": "value",} âŒ
   â˜‘ Tous les tableData commencent par une ligne d'en-tÃªtes non vide

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
RÃˆGLES DE CONTENU OBLIGATOIRES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ¯ STRUCTURE NARRATIVE
â€¢ Architecture : slide titre â†’ dÃ©veloppement progressif â†’ conclusion avec action
â€¢ Progression pÃ©dagogique : gÃ©nÃ©ral â†’ spÃ©cifique, problÃ¨me â†’ solution
â€¢ Alternance types de slides toutes les 2-3 slides (maintien attention)
â€¢ Chaque slide apporte information nouvelle (pas de rÃ©pÃ©tition)

ğŸ“ CONTRAINTES DIMENSIONNELLES
â€¢ Titres slides : MAX 60 caractÃ¨res, formulÃ©s comme affirmations/questions
â€¢ Bullets content : 3-5 par slide, MAX 15 mots chacun
â€¢ TwoColumn : 2-4 points par colonne, MAX 15 mots par point
â€¢ Tables : MAX 4 colonnes, MAX 10 lignes (en-tÃªtes inclus)

âœï¸ STYLE RÃ‰DACTIONNEL
â€¢ Bullets : commencer par verbe d'action (Analyser, Optimiser, DÃ©velopper...)
â€¢ Titres : impactants et synthÃ©tiques (Ã©viter "Introduction", prÃ©fÃ©rer "3 DÃ©fis Majeurs")
â€¢ DerniÃ¨re slide : OBLIGATOIREMENT type "content" avec synthÃ¨se + call-to-action concret

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SCHÃ‰MA JSON OBLIGATOIRE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

{
  "metadata": {
    "title": "Titre principal de la prÃ©sentation (max 60 caractÃ¨res)",
    "author": "Nom de l'auteur ou du prÃ©sentateur",
    "company": "Nom de l'organisation ou entreprise",
    "subject": "Description courte du sujet (optionnel)",
    "fileName": "nom-fichier-sans-espaces-ni-accents.pptx"
  },
  "slides": [
    {
      "type": "title",
      "title": "Titre principal accrocheur et impactant",
      "subtitle": "Sous-titre contextuel apportant prÃ©cision (optionnel)",
      "backgroundColor": "0066CC",
      "titleColor": "FFFFFF"
    },
    {
      "type": "content",
      "title": "Titre clair de la section",
      "bullets": [
        "Premier point avec verbe d'action et bÃ©nÃ©fice clair",
        "DeuxiÃ¨me point apportant une information complÃ©mentaire",
        "TroisiÃ¨me point renforÃ§ant le message principal"
      ]
    },
    {
      "type": "twoColumn",
      "title": "Comparaison ou analyse duale",
      "leftContent": [
        "Point colonne gauche 1 (max 15 mots)",
        "Point colonne gauche 2",
        "Point colonne gauche 3"
      ],
      "rightContent": [
        "Point colonne droite 1 (max 15 mots)",
        "Point colonne droite 2",
        "Point colonne droite 3"
      ]
    },
    {
      "type": "table",
      "title": "DonnÃ©es comparatives structurÃ©es",
      "tableData": [
        ["CritÃ¨re", "Option A", "Option B"],
        ["Performance", "Ã‰levÃ©e", "Moyenne"],
        ["CoÃ»t", "2.5Mâ‚¬", "1.8Mâ‚¬"],
        ["DÃ©lai", "6 mois", "9 mois"]
      ]
    },
    {
      "type": "image",
      "title": "Titre dÃ©crivant le visuel attendu",
      "imagePath": "IMAGE_PLACEHOLDER_graphique-evolution-marche-2020-2025"
    },
    {
      "type": "content",
      "title": "Conclusion et Prochaines Ã‰tapes",
      "bullets": [
        "SynthÃ¨se du point clÃ© numÃ©ro 1",
        "SynthÃ¨se du point clÃ© numÃ©ro 2",
        "Action concrÃ¨te Ã  entreprendre immÃ©diatement"
      ]
    }
  ]
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
TYPES DE SLIDES : SPÃ‰CIFICATIONS DÃ‰TAILLÃ‰ES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

TYPE "title" â€” Page de garde (premiÃ¨re slide UNIQUEMENT)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
PropriÃ©tÃ©s obligatoires :
  â€¢ type: "title"
  â€¢ title: string (max 60 caractÃ¨res)

PropriÃ©tÃ©s optionnelles :
  â€¢ subtitle: string
  â€¢ backgroundColor: string hex 6 caractÃ¨res SANS # (ex: "0066CC")
  â€¢ titleColor: string hex 6 caractÃ¨res SANS # (ex: "FFFFFF")
  â€¢ subtitleColor: string hex 6 caractÃ¨res SANS #

RÃ¨gles :
  âœ“ Doit TOUJOURS Ãªtre la premiÃ¨re slide (slides[0])
  âœ“ Une seule slide title par prÃ©sentation
  âœ“ Couleurs HEX sans diÃ¨se : "0066CC" âœ…  "#0066CC" âŒ

TYPE "content" â€” Liste Ã  puces
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
PropriÃ©tÃ©s obligatoires :
  â€¢ type: "content"
  â€¢ title: string (max 60 caractÃ¨res)
  â€¢ bullets: string[] (3 Ã  5 Ã©lÃ©ments)

RÃ¨gles :
  âœ“ Chaque bullet : MAX 15 mots
  âœ“ Commencer par verbe d'action si possible
  âœ“ DOIT Ãªtre le type de la derniÃ¨re slide (conclusion)

Exemple :
{
  "type": "content",
  "title": "Axes StratÃ©giques 2025",
  "bullets": [
    "DÃ©velopper une offre digitale diffÃ©renciante et personnalisÃ©e",
    "Optimiser les processus internes pour rÃ©duire dÃ©lais de 30%",
    "Former les Ã©quipes aux nouvelles technologies cloud"
  ]
}

TYPE "twoColumn" â€” Comparaison deux colonnes
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
PropriÃ©tÃ©s obligatoires :
  â€¢ type: "twoColumn"
  â€¢ title: string (max 60 caractÃ¨res)
  â€¢ leftContent: string[] (2 Ã  4 Ã©lÃ©ments)
  â€¢ rightContent: string[] (2 Ã  4 Ã©lÃ©ments)

RÃ¨gles :
  âœ“ Chaque point : MAX 15 mots
  âœ“ Pas de propriÃ©tÃ©s leftTitle/rightTitle (non supportÃ©es)
  âœ“ Utile pour : avant/aprÃ¨s, avantages/inconvÃ©nients, comparaisons

Exemple :
{
  "type": "twoColumn",
  "title": "Situation Actuelle vs Objectifs",
  "leftContent": [
    "Processus manuels chronophages",
    "DonnÃ©es dispersÃ©es dans 5 systÃ¨mes",
    "Taux erreur Ã  8%"
  ],
  "rightContent": [
    "Automatisation complÃ¨te des tÃ¢ches rÃ©pÃ©titives",
    "Plateforme unique centralisÃ©e et sÃ©curisÃ©e",
    "Objectif : rÃ©duire erreurs Ã  moins de 2%"
  ]
}

TYPE "table" â€” Tableau de donnÃ©es
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
PropriÃ©tÃ©s obligatoires :
  â€¢ type: "table"
  â€¢ title: string (max 60 caractÃ¨res)
  â€¢ tableData: Array<Array<string>>

Structure tableData IMPÃ‰RATIVE :
  [
    ["En-tÃªte 1", "En-tÃªte 2", "En-tÃªte 3"],  â† Ligne 1 = EN-TÃŠTES (obligatoire)
    ["Valeur 1.1", "Valeur 1.2", "Valeur 1.3"],
    ["Valeur 2.1", "Valeur 2.2", "Valeur 2.3"]
  ]

RÃ¨gles STRICTES :
  âœ“ MAX 4 colonnes
  âœ“ MAX 10 lignes (en-tÃªtes inclus)
  âœ“ PremiÃ¨re ligne = en-tÃªtes (sera automatiquement en gras + fond gris)
  âœ“ TOUS les Ã©lÃ©ments DOIVENT Ãªtre des chaÃ®nes : "45%" âœ…  45 âŒ
  âœ“ Chaque ligne doit avoir le mÃªme nombre de colonnes

Exemple CORRECT :
{
  "type": "table",
  "title": "Comparaison Solutions Cloud",
  "tableData": [
    ["Fournisseur", "CoÃ»t Mensuel", "SLA", "Support"],
    ["AWS", "2500â‚¬", "99.99%", "24/7"],
    ["Azure", "2300â‚¬", "99.95%", "24/7"],
    ["GCP", "2100â‚¬", "99.9%", "Heures bureau"]
  ]
}

Exemple INCORRECT (nombres non quotÃ©s) :
{
  "tableData": [
    ["MÃ©trique", "2023", "2024"],
    ["Revenue", 2500000, 3200000],  âŒ Nombres bruts
    ["Croissance", 0.28, 0.35]       âŒ Floats bruts
  ]
}

Correction :
{
  "tableData": [
    ["MÃ©trique", "2023", "2024"],
    ["Revenue", "2.5Mâ‚¬", "3.2Mâ‚¬"],   âœ… Strings formatÃ©es
    ["Croissance", "+28%", "+35%"]   âœ… Strings avec contexte
  ]
}

TYPE "image" â€” Visuel ou placeholder
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
PropriÃ©tÃ©s obligatoires :
  â€¢ type: "image"
  â€¢ title: string (max 60 caractÃ¨res)
  â€¢ imagePath: string

Formats imagePath acceptÃ©s :
  1ï¸âƒ£ Data URI base64 (fonctionnement hors-ligne) :
     "data:image/png;base64,iVBORw0KGgoAAAANS..."
  
  2ï¸âƒ£ Placeholder descriptif (cadre sera insÃ©rÃ©) :
     "IMAGE_PLACEHOLDER_description-detaillee-du-visuel"

Formats INTERDITS :
  âŒ URLs HTTP/HTTPS : "https://exemple.com/image.jpg"
  âŒ Chemins relatifs : "./images/chart.png"
  âŒ Chemins absolus locaux : "/Users/john/Desktop/image.png"

RÃ¨gles :
  âœ“ PrivilÃ©gier placeholders pour gÃ©nÃ©ration initiale
  âœ“ Description placeholder : tirets, pas d'espaces
  âœ“ Data URI : uniquement si image dÃ©jÃ  disponible en base64

Exemple placeholder :
{
  "type": "image",
  "title": "Ã‰volution du Chiffre d'Affaires",
  "imagePath": "IMAGE_PLACEHOLDER_graphique-courbe-CA-2020-2025-avec-projections"
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
CHECKLIST VALIDATION FINALE (Ã  vÃ©rifier mentalement avant retour)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â–¡ 1. Nombre de slides = NOMBRE_SLIDES spÃ©cifiÃ©
â–¡ 2. PremiÃ¨re slide = type "title"
â–¡ 3. DerniÃ¨re slide = type "content" avec call-to-action
â–¡ 4. metadata.title prÃ©sent et < 60 caractÃ¨res
â–¡ 5. metadata.fileName : minuscules, tirets, .pptx
â–¡ 6. Aucun titre de slide > 60 caractÃ¨res
â–¡ 7. Bullets content : 3-5 par slide, â‰¤ 15 mots chacun
â–¡ 8. TwoColumn : 2-4 points par colonne, â‰¤ 15 mots
â–¡ 9. Tables : premiÃ¨re ligne = en-tÃªtes, â‰¤ 4 colonnes, â‰¤ 10 lignes
â–¡ 10. Tables : TOUS les Ã©lÃ©ments sont des strings
â–¡ 11. imagePath : data URI ou IMAGE_PLACEHOLDER_...
â–¡ 12. Aucun guillemet typographique Â« Â» " "
â–¡ 13. Aucune virgule finale dans objets/tableaux
â–¡ 14. Alternance raisonnable des types de slides
â–¡ 15. Progression logique du contenu

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EXEMPLE COMPLET DE RÃ‰FÃ‰RENCE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

{
  "metadata": {
    "title": "StratÃ©gie Marketing Digital 2025",
    "author": "Marie Dupont",
    "company": "TechCorp Solutions",
    "subject": "Transformation digitale et croissance",
    "fileName": "strategie-marketing-digital-2025.pptx"
  },
  "slides": [
    {
      "type": "title",
      "title": "StratÃ©gie Marketing Digital 2025",
      "subtitle": "AccÃ©lÃ©rer notre transformation pour doubler l'impact",
      "backgroundColor": "0066CC",
      "titleColor": "FFFFFF",
      "subtitleColor": "E0E0E0"
    },
    {
      "type": "content",
      "title": "Contexte : Un MarchÃ© en Mutation Rapide",
      "bullets": [
        "Croissance digitale de 45% depuis 2023 dans notre secteur",
        "Concurrence accrue nÃ©cessitant diffÃ©renciation forte et rapide",
        "Attentes clients Ã©voluent vers expÃ©rience hyper-personnalisÃ©e",
        "Budget marketing doit gÃ©nÃ©rer ROI mesurable sous 6 mois"
      ]
    },
    {
      "type": "twoColumn",
      "title": "Situation Actuelle vs Vision 2025",
      "leftContent": [
        "PrÃ©sence limitÃ©e aux rÃ©seaux sociaux classiques",
        "Taux de conversion moyen de 2.3%",
        "Budget dispersÃ© sur 12 canaux diffÃ©rents"
      ],
      "rightContent": [
        "Ã‰cosystÃ¨me digital omnicanal cohÃ©rent et optimisÃ©",
        "Objectif conversion Ã  5% d'ici T2 2025",
        "Budget concentrÃ© sur 5 canaux Ã  fort ROI"
      ]
    },
    {
      "type": "table",
      "title": "Comparaison Performance Canaux Digitaux",
      "tableData": [
        ["Canal", "CoÃ»t Acquisition", "ROI EstimÃ©", "PrioritÃ©"],
        ["SEO", "45â‚¬", "320%", "Haute"],
        ["Google Ads", "78â‚¬", "180%", "Haute"],
        ["LinkedIn", "125â‚¬", "150%", "Moyenne"],
        ["Facebook", "52â‚¬", "95%", "Faible"]
      ]
    },
    {
      "type": "content",
      "title": "Actions Prioritaires Q1 2025",
      "bullets": [
        "Refonte complÃ¨te du site web avec UX optimisÃ©e",
        "Lancement campagne SEO sur 50 mots-clÃ©s stratÃ©giques",
        "Automatisation email marketing avec segmentation",
        "CrÃ©ation contenu vidÃ©o pour rÃ©seaux sociaux"
      ]
    },
    {
      "type": "image",
      "title": "Projection Croissance CA Digital 2025-2027",
      "imagePath": "IMAGE_PLACEHOLDER_graphique-courbe-projection-ca-digital-avec-zones-croissance"
    },
    {
      "type": "content",
      "title": "Plan d'Action : 3 Piliers StratÃ©giques",
      "bullets": [
        "Pilier 1 : Optimiser SEO et contenu pour doubler trafic organique",
        "Pilier 2 : Lancer campagnes Google Ads ciblÃ©es avec A/B testing",
        "Pilier 3 : DÃ©ployer plateforme CRM pour personnalisation client",
        "Objectif global : atteindre 5Mâ‚¬ CA digital fin 2025"
      ]
    },
    {
      "type": "content",
      "title": "Prochaines Ã‰tapes et Engagement",
      "bullets": [
        "Validation budget de 450Kâ‚¬ avant fin du mois",
        "Recrutement d'un Growth Hacker senior sous 6 semaines",
        "Lancement campagne pilote SEO dÃ¨s le 15 janvier",
        "Rendez-vous mensuel pour suivi KPIs et ajustements"
      ]
    }
  ]
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
RAPPEL FINAL : ERREURS FRÃ‰QUENTES Ã€ Ã‰VITER ABSOLUMENT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âŒ Virgule finale : {"slides": [...],}
âŒ Guillemets typographiques : "Le concept Â«innovationÂ» est clÃ©"
âŒ Nombres bruts dans tables : ["CA", 2500000] au lieu de ["CA", "2.5Mâ‚¬"]
âŒ Couleurs avec # : {"backgroundColor": "#0066CC"} au lieu de "0066CC"
âŒ Images HTTP : "imagePath": "https://..." (non compatible hors-ligne)
âŒ Oubli Ã©chappement : "Le mot "test"" au lieu de "Le mot \"test\""
âŒ Tableaux sans en-tÃªtes : [["Val1", "Val2"]] au lieu de [["Col1", "Col2"], ["Val1", "Val2"]]
âŒ Bullets trop longs : > 15 mots (dilue le message)
âŒ PremiÃ¨re slide pas "title" : Slide 1 doit toujours Ãªtre type "title"
âŒ DerniÃ¨re slide pas "content" : DerniÃ¨re doit contenir conclusion/action

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

GÃ‰NÃ‰RATION : Produis maintenant le JSON en respectant TOUTES les rÃ¨gles ci-dessus.
  </script>
  <script>
    (function loadPptxGenRobust() {
      const container = document.getElementById('pptxgen-bundle-data');

      // === NIVEAU 1 : Tentative chargement depuis base64 embarquÃ© ===
      if (container) {
        const base64 = container.textContent.replace(/\s+/g, '');

        if (base64 && base64 !== '<!--PPTX_BUNDLE_BASE64-->' && base64.length > 10000) {
          try {
            const scriptEl = document.createElement('script');
            scriptEl.type = 'text/javascript';
            scriptEl.textContent = atob(base64);
            document.head.appendChild(scriptEl);
            console.info('âœ“ PptxGenJS chargÃ© depuis base64 embarquÃ©');
            return;
          } catch (err) {
            console.warn('âš ï¸ Ã‰chec dÃ©codage base64, tentative fallback...', err);
          }
        } else {
          console.warn('âš ï¸ Base64 manquant/invalide, tentative fallback...');
        }
      }

      // === NIVEAU 2 : Fallback vers fichier externe pptxgen.bundle.js ===
      const fallbackScript = document.createElement('script');
      fallbackScript.src = './pptxgen.bundle.js';
      fallbackScript.onerror = () => {
        console.error('âŒ Ã‰chec chargement pptxgen.bundle.js externe');
        showCriticalError();
      };
      fallbackScript.onload = () => {
        console.info('âœ“ PptxGenJS chargÃ© depuis fichier externe (fallback)');
      };
      document.head.appendChild(fallbackScript);

      function showCriticalError() {
        document.body.innerHTML = `
          <div style="
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, #fc8181 0%, #c53030 100%);
            color: white; display: flex; align-items: center; justify-content: center;
            font-family: system-ui, -apple-system, sans-serif; padding: 40px; z-index: 9999;
          ">
            <div style="max-width: 600px; text-align: center;">
              <div style="font-size: 72px; margin-bottom: 20px;">âš ï¸</div>
              <h1 style="font-size: 28px; margin: 0 0 16px; font-weight: 700;">
                Erreur Critique : BibliothÃ¨que Manquante
              </h1>
              <p style="font-size: 18px; line-height: 1.6; margin: 0 0 24px; opacity: 0.95;">
                La bibliothÃ¨que <code style="background: rgba(0,0,0,0.3); padding: 2px 8px; border-radius: 4px;">pptxgen.bundle.js</code>
                n'a pas pu Ãªtre chargÃ©e.
              </p>
              <div style="background: rgba(0,0,0,0.2); padding: 20px; border-radius: 8px; text-align: left; font-size: 14px;">
                <strong>Solutions :</strong><br>
                1. VÃ©rifiez que <code>pptxgen.bundle.js</code> est dans le mÃªme dossier<br>
                2. Si vous utilisez la version embarquÃ©e, vÃ©rifiez le placeholder base64<br>
                3. Ouvrez la console (F12) pour voir les dÃ©tails de l'erreur
              </div>
            </div>
          </div>
        ";
      }
    })();

    function checkPptxGenAvailable() {
      if (typeof window.PptxGenJS === 'undefined' && typeof window.pptxgen === 'undefined') {
        throw new Error(
          "PptxGenJS n'est pas disponible.\n" +
          'VÃ©rifiez que pptxgen.bundle.js est correctement chargÃ©.\n' +
          'Rechargez la page ou consultez la console pour plus de dÃ©tails.'
        );
      }
      return window.PptxGenJS || window.pptxgen;
    }
  </script>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh; margin: 0; padding: 20px;
    }
    .container {
      max-width: 1200px; margin: 0 auto; background: #fff; border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1); overflow: hidden;
    }
    header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; padding: 40px; text-align: center; }
    header h1 { font-size: 32px; font-weight: 700; margin: 0 0 10px; }
    header p { font-size: 16px; opacity: .9; margin: 0; }
    .content { padding: 40px; }

    .instructions { background: #f0f4ff; border-left: 4px solid #667eea; padding: 20px; margin-bottom: 30px; border-radius: 8px; }
    .instructions h2 { color: #667eea; font-size: 20px; margin: 0 0 15px; }
    .instructions ol { margin: 0 0 0 20px; line-height: 1.8; color: #4a5568; }

    .section { margin-bottom: 30px; }
    .section-title { font-size: 18px; font-weight: 600; color: #2d3748; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }

    .btn { background: #667eea; color: #fff; border: none; padding: 12px 24px; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 8px; }
    .btn:hover { background: #5a67d8; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(102,126,234,.35); }
    .btn:active { transform: translateY(0); }
    .btn[disabled] { opacity: .6; cursor: not-allowed; box-shadow: none; transform: none; }
    .btn-primary { background: #48bb78; font-size: 18px; padding: 16px 32px; }
    .btn-primary:hover { background: #38a169; box-shadow: 0 4px 12px rgba(72,187,120,.35); }
    .copy-btn { background: #ed8936; }
    .copy-btn:hover { background: #dd6b20; }

    textarea { width: 100%; min-height: 450px; padding: 20px; border: 2px solid #e2e8f0; border-radius: 8px; font-family: Consolas, Monaco, 'Courier New', monospace; font-size: 14px; line-height: 1.6; resize: vertical; transition: border-color .2s ease; }
    textarea:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,.15); }

    .alert { padding: 16px 20px; border-radius: 8px; margin-top: 20px; display: none; animation: slideIn .2s ease; white-space: pre-wrap; }
    .alert-error { background: #fff5f5; border-left: 4px solid #fc8181; color: #c53030; }
    .alert-success { background: #f0fff4; border-left: 4px solid #68d391; color: #2f855a; }
    .alert-warning { background: #fffaf0; border-left: 4px solid #f6ad55; color: #c05621; }
    @keyframes slideIn { from { opacity: 0; transform: translateY(-6px);} to { opacity:1; transform: translateY(0);} }

    .collapsible { background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden; }
    .collapsible + .collapsible { margin-top: 16px; }
    .collapsible-header { padding: 16px 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 600; color: #2d3748; transition: background .15s ease; }
    .collapsible-header:hover { background: #edf2f7; }
    .collapsible-content { max-height: 0; overflow: hidden; transition: max-height .25s ease; }
    .collapsible-content.active { max-height: 2000px; }
    .collapsible-body { padding: 20px; border-top: 1px solid #e2e8f0; }
    pre { background: #2d3748; color: #e2e8f0; padding: 20px; border-radius: 6px; overflow-x: auto; font-size: 13px; line-height: 1.6; }

    .prompt-box { background: #fffaf0; border: 2px solid #ed8936; border-radius: 8px; padding: 20px; margin-top: 15px; }
    .prompt-box textarea { background: #fff; min-height: 300px; font-size: 13px; }
    #copyFeedback { color: #38a169; margin-top: 10px; display: none; }

    .spinner { display: inline-block; width: 18px; height: 18px; border: 3px solid rgba(0,0,0,.1); border-left-color: #fff; border-radius: 50%; animation: spin 1s linear infinite; vertical-align: text-bottom; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ğŸ¯ GÃ©nÃ©rateur PowerPoint Professionnel</h1>
      <p>CrÃ©ez des prÃ©sentations de qualitÃ© en quelques secondes â€” 100% horsâ€‘ligne</p>
    </header>

    <div class="content">
      <div class="instructions">
        <h2>ğŸ“‹ Comment utiliser ce gÃ©nÃ©rateur</h2>
        <ol>
          <li><strong>TÃ©lÃ©chargez</strong> <code>pptxgen.bundle.js</code> et placez-le Ã  cÃ´tÃ© de ce fichier HTML.</li>
          <li><strong>Affichez et copiez</strong> le prompt optimal (bouton ci-dessous), renseignez vos variables (SUJET, AUDIENCE, ...).</li>
          <li><strong>Collez</strong> le JSON gÃ©nÃ©rÃ© par lâ€™IA dans la zone de texte.</li>
          <li><strong>Cliquez</strong> sur Â« GÃ©nÃ©rer PowerPoint Â» pour obtenir le <code>.pptx</code>.</li>
        </ol>
      </div>

      <div class="section">
        <button class="btn" onclick="togglePrompt()">ğŸ“ Afficher le Prompt Optimal</button>
        <div id="promptBox" class="prompt-box" style="display:none;">
          <div class="section-title">Prompt Ã  copier dans votre IA :</div>
          <textarea id="promptText" readonly></textarea>
          <button class="btn copy-btn" onclick="copyPrompt()">ğŸ“‹ Copier le Prompt</button>
          <div id="copyFeedback" role="status" aria-live="polite" data-default-message="âœ“ Prompt copiÃ© dans le presseâ€‘papier !">âœ“ Prompt copiÃ© dans le presseâ€‘papier !</div>
        </div>
      </div>

      <div class="section">
        <div class="section-title">ğŸ“„ Collez ici le JSON gÃ©nÃ©rÃ© par lâ€™IA :</div>
        <textarea id="jsonInput" placeholder='Collez votre JSON ici...'></textarea>
      </div>

      <div class="section">
        <button id="generateBtn" class="btn btn-primary" onclick="generatePowerPoint()">
          <span id="genLabel">ğŸš€ GÃ©nÃ©rer PowerPoint</span>
          <span id="genSpin" style="display:none;" class="spinner"></span>
        </button>
      </div>

      <div id="error" class="alert alert-error" role="alert" aria-live="assertive"></div>
      <div id="success" class="alert alert-success" role="status" aria-live="polite"></div>
      <div id="warning" class="alert alert-warning" role="status" aria-live="polite"></div>

      <div class="collapsible">
        <div class="collapsible-header" onclick="toggleCollapsible(this)">
          <span>ğŸ’¡ Exemple JSON Minimal</span><span>â–¼</span>
        </div>
        <div class="collapsible-content">
          <div class="collapsible-body">
<pre>{
  "metadata": {
    "title": "Ma PrÃ©sentation",
    "author": "Votre Nom",
    "company": "Votre Organisation",
    "fileName": "ma-presentation.pptx"
  },
  "slides": [
    {
      "type": "title",
      "title": "Titre Principal",
      "subtitle": "Sous-titre descriptif",
      "backgroundColor": "0066CC",
      "titleColor": "FFFFFF"
    },
    {
      "type": "content",
      "title": "Points ClÃ©s",
      "bullets": [
        "DÃ©finir lâ€™objectif de la prÃ©sentation",
        "Structurer le message en 3 points",
        "Clore avec un appel Ã  lâ€™action"
      ]
    }
  ]
}</pre>
          </div>
        </div>
      </div>

      <div class="collapsible">
        <div class="collapsible-header" onclick="toggleCollapsible(this)">
          <span>ğŸ”§ Types de Slides SupportÃ©s</span><span>â–¼</span>
        </div>
        <div class="collapsible-content">
          <div class="collapsible-body">
            <p><strong>1. title</strong> â€” Page de titre (obligatoirement la 1Ê³áµ‰ slide)</p>
            <p><strong>2. content</strong> â€” Points (3 Ã  5 bullets, â‰¤ 15 mots chacun)</p>
            <p><strong>3. twoColumn</strong> â€” Deux colonnes (2 Ã  4 points par colonne)</p>
            <p><strong>4. table</strong> â€” Tableau (â‰¤ 4 colonnes, â‰¤ 10 lignes)</p>
            <p><strong>5. image</strong> â€” Image <em>offline</em> (data URI <code>data:image/...</code>) ou placeholder <code>IMAGE_PLACEHOLDER_â€¦</code> (aucune URL http/https)</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== 1) CONSTANTES DE LAYOUT (16:9) =====
    const LAYOUT = {
      width: 10,
      height: 5.625,
      margin: 0.5,
      titleHeight: 0.7,
      contentGap: 0.2,
      columnGap: 0.3,
      bulletIndent: 0.25
    };

    const ZONES = {
      title: {
        x: LAYOUT.margin,
        y: LAYOUT.margin,
        w: LAYOUT.width - (2 * LAYOUT.margin),
        h: LAYOUT.titleHeight
      },
      content: {
        x: LAYOUT.margin + LAYOUT.bulletIndent,
        y: LAYOUT.margin + LAYOUT.titleHeight + LAYOUT.contentGap,
        w: LAYOUT.width - (2 * LAYOUT.margin) - LAYOUT.bulletIndent,
        h: LAYOUT.height - (LAYOUT.margin + LAYOUT.titleHeight + LAYOUT.contentGap + LAYOUT.margin)
      }
    };

    const TITLE_MAX_LENGTH = 60;
    const MAX_BULLET_WORDS = 15;
    const COLUMN_WORD_LIMIT = 15;
    const FILENAME_PATTERN = /^[a-z0-9_-][a-z0-9._-]*\.pptx$/i;

    // ===== Helpers =====
    function isHex6(v) { return typeof v === 'string' && /^[0-9A-Fa-f]{6}$/.test(v); }
    function countWords(s) { return String(s).trim().split(/\s+/).filter(Boolean).length; }
    function isDataUri(s) { return typeof s === 'string' && s.startsWith('data:image/'); }
    function isPlaceholderUri(s) { return typeof s === 'string' && s.startsWith('IMAGE_PLACEHOLDER_'); }
    function isNonEmptyString(value) { return typeof value === 'string' && value.trim().length > 0; }

    
    // âœ… AMÃ‰LIORATION v2.0 : Normalisation sÃ©curisÃ©e des tables
    function normalizeTableDataSafe(tableData) {
      try {
        if (!Array.isArray(tableData) || tableData.length === 0) {
          console.warn('âš ï¸ normalizeTableDataSafe : donnÃ©es invalides, retour placeholder');
          return [['Erreur'], ['DonnÃ©es invalides']];
        }

        const normalized = tableData.map((row, rowIndex) => {
          if (!Array.isArray(row)) {
            console.warn('âš ï¸ Ligne non-tableau dÃ©tectÃ©e:', row);
            return ['Erreur ligne'];
          }
          
          return row.map(cell => {
            // Gestion des cellules null/undefined
            if (cell === null || cell === undefined) {
              return { text: '' };
            }
            
            // Si c'est dÃ©jÃ  un objet avec text
            if (typeof cell === 'object' && cell.text !== undefined) {
              return cell;
            }
            
            // Conversion en string sÃ©curisÃ©e
            const textValue = String(cell);
            
            // Si c'est un header (premiÃ¨re ligne), style diffÃ©rent
            const isHeader = rowIndex === 0;
            
            return {
              text: textValue,
              options: isHeader ? {
                fontSize: 14,
                bold: true,
                color: 'FFFFFF',
                fill: '0066CC',
                align: 'center',
                valign: 'middle'
              } : {
                fontSize: 12,
                color: '333333',
                align: 'left',
                valign: 'middle'
              }
            };
          });
        });

        return normalized;
      } catch (error) {
        console.error('âŒ normalizeTableDataSafe : exception', error);
        return [['Erreur critique'], [error.message]];
      }
    }

    function normalizeTableData(rows) {
      try {
        return normalizeTableDataSafe(rows);
      } catch (err) {
        console.error('Table invalide dÃ©tectÃ©e:', rows, err);
        return [[{
          text: 'ERREUR TABLE',
          options: { bold: true, fill: 'FC8181', color: 'FFFFFF' }
        }]];
      }
    }

    function normalizeTableDataSafe(rows) {
      if (!Array.isArray(rows)) {
        throw new Error(`tableData n'est pas un tableau (type: ${typeof rows})`);
      }
      if (rows.length === 0) {
        throw new Error('tableData est un tableau vide');
      }
      if (!Array.isArray(rows[0])) {
        throw new Error(`PremiÃ¨re ligne (en-tÃªtes) n'est pas un tableau (type: ${typeof rows[0]})`);
      }
      if (rows[0].length === 0) {
        throw new Error("Ligne d'en-tÃªtes est vide");
      }

      return rows.map((row, idxRow) => {
        if (!Array.isArray(row)) {
          console.warn(`normalizeTableDataSafe: ligne ${idxRow} n'est pas un tableau, conversion en [row]`);
          row = [row];
        }

        return row.map((cell, idxCell) => {
          if (cell && typeof cell === 'object' && !Array.isArray(cell) && 'text' in cell) {
            return {
              text: String(cell.text ?? ''),
              options: cell.options || (idxRow === 0 ? { bold: true, fill: 'E1E1E1', color: '000000' } : {})
            };
          }

          let textValue;
          if (cell === null || cell === undefined) {
            textValue = '';
          } else if (typeof cell === 'object') {
            textValue = JSON.stringify(cell);
          } else {
            textValue = String(cell);
          }

          return {
            text: textValue,
            options: idxRow === 0 ? { bold: true, fill: 'E1E1E1', color: '000000' } : {}
          };
        });
      });
    }

    // ===== 2) VALIDATION JSON COMPLÃˆTE =====
    function validateJSON(data) {
      const errors = [];
      const warns = [];

      if (!data || typeof data !== 'object') {
        errors.push('Le JSON doit Ãªtre un objet valide');
        return { errors, warns };
      }

      // Metadata
      if (!data.metadata) errors.push("PropriÃ©tÃ© 'metadata' manquante");
      else {
        const meta = data.metadata;
        if (!isNonEmptyString(meta.title)) {
          errors.push('metadata.title est obligatoire et doit Ãªtre une chaÃ®ne non vide');
        } else if (meta.title.trim().length > TITLE_MAX_LENGTH) {
          errors.push(`metadata.title ne peut pas dÃ©passer ${TITLE_MAX_LENGTH} caractÃ¨res (actuel : ${meta.title.trim().length})`);
        }
        if (!isNonEmptyString(meta.fileName)) {
          errors.push('metadata.fileName est obligatoire et doit Ãªtre une chaÃ®ne non vide');
        } else if (!FILENAME_PATTERN.test(meta.fileName)) {
          errors.push('metadata.fileName doit Ãªtre en minuscules, sans espaces ni accents, et se terminer par .pptx');
        }
      }

      // Slides
      if (!data.slides || !Array.isArray(data.slides)) {
        errors.push("PropriÃ©tÃ© 'slides' doit Ãªtre un tableau");
        return { errors, warns };
      }
      if (data.slides.length === 0) {
        errors.push("Le tableau 'slides' ne peut pas Ãªtre vide");
        return { errors, warns };
      }

      // RÃ¨gles globales
      const validTypes = ['title', 'content', 'twoColumn', 'table', 'image'];
      if (data.slides[0]?.type !== 'title') {
        errors.push('La premiÃ¨re slide doit Ãªtre de type "title"');
      }

      // DerniÃ¨re slide : recommandation forte â†’ on lâ€™impose ici
      const last = data.slides[data.slides.length - 1];
      if (last?.type !== 'content') {
        errors.push('La derniÃ¨re slide doit Ãªtre de type "content" (conclusion + call-to-action)');
      }

      data.slides.forEach((slide, i) => {
        const n = i + 1;
        if (!slide || typeof slide !== 'object') {
          errors.push(`Slide ${n} : Ã©lÃ©ment invalide (objet attendu)`);
          return;
        }
        if (!slide.type) {
          errors.push(`Slide ${n} : propriÃ©tÃ© 'type' manquante`);
          return;
        }
        if (!validTypes.includes(slide.type)) {
          errors.push(`Slide ${n} : type '${slide.type}' invalide. Types valides : ${validTypes.join(', ')}`);
          return;
        }

        // RÃ¨gles par type
        switch (slide.type) {
          case 'title': {
            if (!isNonEmptyString(slide.title)) {
              errors.push(`Slide ${n} (title) : 'title' obligatoire et doit Ãªtre une chaÃ®ne non vide`);
            } else if (slide.title.trim().length > TITLE_MAX_LENGTH) {
              errors.push(`Slide ${n} (title) : le titre ne peut pas dÃ©passer ${TITLE_MAX_LENGTH} caractÃ¨res (actuel : ${slide.title.trim().length})`);
            }
            if (slide.backgroundColor && !isHex6(slide.backgroundColor)) errors.push(`Slide ${n} : backgroundColor doit Ãªtre hex 6 (ex: 0066CC)`);
            if (slide.titleColor && !isHex6(slide.titleColor)) errors.push(`Slide ${n} : titleColor doit Ãªtre hex 6 (ex: FFFFFF)`);
            if (slide.subtitleColor && !isHex6(slide.subtitleColor)) errors.push(`Slide ${n} : subtitleColor doit Ãªtre hex 6`);
            break;
          }
          case 'content': {
            if (!isNonEmptyString(slide.title)) {
              errors.push(`Slide ${n} : propriÃ©tÃ© 'title' manquante ou vide`);
            } else if (slide.title.trim().length > TITLE_MAX_LENGTH) {
              errors.push(`Slide ${n} : le titre ne peut pas dÃ©passer ${TITLE_MAX_LENGTH} caractÃ¨res (actuel : ${slide.title.trim().length})`);
            }
            if (!Array.isArray(slide.bullets)) errors.push(`Slide ${n} (content) : 'bullets' doit Ãªtre un tableau`);
            else {
              if (slide.bullets.length < 3 || slide.bullets.length > 5) errors.push(`Slide ${n} (content) : 3 Ã  5 bullets requis`);
              slide.bullets.forEach((b, bi) => {
                if (!isNonEmptyString(b)) {
                  errors.push(`Slide ${n} (content) bullet ${bi+1} : doit Ãªtre une chaÃ®ne non vide`);
                  return;
                }
                const words = countWords(b);
                if (words > MAX_BULLET_WORDS) errors.push(`Slide ${n} (content) bullet ${bi+1} : max ${MAX_BULLET_WORDS} mots (actuel : ${words})`);
              });
            }
            break;
          }
          case 'twoColumn': {
            if (!isNonEmptyString(slide.title)) {
              errors.push(`Slide ${n} : propriÃ©tÃ© 'title' manquante ou vide`);
            } else if (slide.title.trim().length > TITLE_MAX_LENGTH) {
              errors.push(`Slide ${n} : le titre ne peut pas dÃ©passer ${TITLE_MAX_LENGTH} caractÃ¨res (actuel : ${slide.title.trim().length})`);
            }
            if (!Array.isArray(slide.leftContent)) errors.push(`Slide ${n} (twoColumn) : 'leftContent' doit Ãªtre un tableau`);
            if (!Array.isArray(slide.rightContent)) errors.push(`Slide ${n} (twoColumn) : 'rightContent' doit Ãªtre un tableau`);
            if (Array.isArray(slide.leftContent) && (slide.leftContent.length < 2 || slide.leftContent.length > 4)) errors.push(`Slide ${n} (twoColumn) : 2 Ã  4 points Ã  gauche`);
            if (Array.isArray(slide.rightContent) && (slide.rightContent.length < 2 || slide.rightContent.length > 4)) errors.push(`Slide ${n} (twoColumn) : 2 Ã  4 points Ã  droite`);
            if (Array.isArray(slide.leftContent)) {
              slide.leftContent.forEach((item, idx) => {
                if (!isNonEmptyString(item)) {
                  errors.push(`Slide ${n} (twoColumn) colonne gauche point ${idx+1} : doit Ãªtre une chaÃ®ne non vide`);
                  return;
                }
                const words = countWords(item);
                if (words > COLUMN_WORD_LIMIT) errors.push(`Slide ${n} (twoColumn) colonne gauche point ${idx+1} : max ${COLUMN_WORD_LIMIT} mots (actuel : ${words})`);
              });
            }
            if (Array.isArray(slide.rightContent)) {
              slide.rightContent.forEach((item, idx) => {
                if (!isNonEmptyString(item)) {
                  errors.push(`Slide ${n} (twoColumn) colonne droite point ${idx+1} : doit Ãªtre une chaÃ®ne non vide`);
                  return;
                }
                const words = countWords(item);
                if (words > COLUMN_WORD_LIMIT) errors.push(`Slide ${n} (twoColumn) colonne droite point ${idx+1} : max ${COLUMN_WORD_LIMIT} mots (actuel : ${words})`);
              });
            }
            break;
          }
          case 'table': {
            if (!isNonEmptyString(slide.title)) {
              errors.push(`Slide ${n} : propriÃ©tÃ© 'title' manquante ou vide`);
            } else if (slide.title.trim().length > TITLE_MAX_LENGTH) {
              errors.push(`Slide ${n} : le titre ne peut pas dÃ©passer ${TITLE_MAX_LENGTH} caractÃ¨res (actuel : ${slide.title.trim().length})`);
            }

            if (!slide.tableData) {
              errors.push(`Slide ${n} (table) : propriÃ©tÃ© 'tableData' manquante`);
              break;
            }

            if (!Array.isArray(slide.tableData)) {
              errors.push(`Slide ${n} (table) : 'tableData' doit Ãªtre un tableau (type reÃ§u: ${typeof slide.tableData})`);
              break;
            }

            if (slide.tableData.length === 0) {
              errors.push(`Slide ${n} (table) : 'tableData' ne peut pas Ãªtre vide`);
              break;
            }

            const header = slide.tableData[0];

            if (!Array.isArray(header)) {
              errors.push(`Slide ${n} (table) : la premiÃ¨re ligne (en-tÃªtes) doit Ãªtre un tableau (type reÃ§u: ${typeof header})`);
              break;
            }

            if (header.length === 0) {
              errors.push(`Slide ${n} (table) : la ligne d'en-tÃªtes ne peut pas Ãªtre vide`);
              break;
            }

            let hasInvalidHeaders = false;
            header.forEach((cell, idx) => {
              const cellText = typeof cell === 'object' && cell !== null ? cell.text : cell;
              if (!isNonEmptyString(cellText)) {
                errors.push(`Slide ${n} (table) : en-tÃªte colonne ${idx + 1} doit Ãªtre une chaÃ®ne non vide (reÃ§u: ${JSON.stringify(cell)})`);
                hasInvalidHeaders = true;
              }
            });

            if (hasInvalidHeaders) {
              break;
            }

            const colCount = header.length;

            if (colCount > 4) {
              errors.push(`Slide ${n} (table) : maximum 4 colonnes autorisÃ©es (actuel : ${colCount})`);
            }

            if (slide.tableData.length > 10) {
              errors.push(`Slide ${n} (table) : maximum 10 lignes autorisÃ©es (en-tÃªtes inclus, actuel : ${slide.tableData.length})`);
            }

            slide.tableData.slice(1).forEach((row, idx) => {
              const rowNum = idx + 2;
              if (!Array.isArray(row)) {
                errors.push(`Slide ${n} (table) ligne ${rowNum} : chaque ligne doit Ãªtre un tableau (type reÃ§u: ${typeof row})`);
                return;
              }

              if (row.length !== colCount) {
                warns.push(`Slide ${n} (table) ligne ${rowNum} : nombre de colonnes incohÃ©rent (${row.length} cellules vs ${colCount} en-tÃªtes)`);
              }

              row.forEach((cell, cellIdx) => {
                if (cell === null || cell === undefined) {
                  warns.push(`Slide ${n} (table) ligne ${rowNum} colonne ${cellIdx + 1} : cellule vide/null dÃ©tectÃ©e`);
                }
              });
            });

            try {
              slide._normalizedTableData = normalizeTableDataSafe(slide.tableData);
            } catch (normError) {
              errors.push(`Slide ${n} (table) : Ã©chec normalisation des donnÃ©es - ${normError.message}`);
            }

            break;
          }
          case 'image': {
            if (!isNonEmptyString(slide.title)) {
              errors.push(`Slide ${n} : propriÃ©tÃ© 'title' manquante ou vide`);
            } else if (slide.title.trim().length > TITLE_MAX_LENGTH) {
              errors.push(`Slide ${n} : le titre ne peut pas dÃ©passer ${TITLE_MAX_LENGTH} caractÃ¨res (actuel : ${slide.title.trim().length})`);
            }
            if (!isNonEmptyString(slide.imagePath)) {
              errors.push(`Slide ${n} (image) : 'imagePath' manquante`);
            } else if (!(isDataUri(slide.imagePath) || isPlaceholderUri(slide.imagePath))) {
              errors.push(`Slide ${n} (image) : imagePath doit Ãªtre un data URI (data:image/...) ou un placeholder IMAGE_PLACEHOLDER_... (aucune URL http/https)`);
            }
            break;
          }
        }
      });

      return { errors, warns };
    }

    // ===== 3) FONCTIONS CRÃ‰ATION DE SLIDES (correctifs v2) =====
    function createTitleSlide(slide, data) {
      if (data.backgroundColor) slide.background = { color: data.backgroundColor };
      const titleY = (LAYOUT.height - 1.5) / 2;

      slide.addText(data.title, {
        x: LAYOUT.margin,
        y: titleY,
        w: LAYOUT.width - (2 * LAYOUT.margin),
        h: 1.0,
        fontSize: 44,
        bold: true,
        color: data.titleColor || '363636',
        align: 'center',
        valign: 'middle'
      });

      if (data.subtitle) {
        slide.addText(data.subtitle, {
          x: LAYOUT.margin,
          y: titleY + 1.2,
          w: LAYOUT.width - (2 * LAYOUT.margin),
          h: 0.6,
          fontSize: 24,
          color: data.subtitleColor || '666666',
          align: 'center',
          valign: 'middle'
        });
      }
    }

    function createContentSlide(slide, data) {
      slide.addText(data.title, {
        ...ZONES.title,
        fontSize: 32,
        bold: true,
        color: '0066cc'
      });

      const bulletText = data.bullets.map(b => ({
        text: String(b),
        options: { bullet: true, fontSize: 18, color: '333333' }
      }));

      slide.addText(bulletText, {
        ...ZONES.content,
        fontSize: 18,
        color: '333333',
        valign: 'top'
      });
    }

    function createTwoColumnSlide(slide, data) {
      slide.addText(data.title, {
        ...ZONES.title,
        fontSize: 32,
        bold: true,
        color: '0066cc'
      });

      const columnWidth = (ZONES.content.w - LAYOUT.columnGap) / 2;

      const leftText = data.leftContent.map(t => ({
        text: String(t),
        options: { bullet: true, fontSize: 16, color: '333333' }
      }));

      const rightText = data.rightContent.map(t => ({
        text: String(t),
        options: { bullet: true, fontSize: 16, color: '333333' }
      }));

      slide.addText(leftText, {
        x: ZONES.content.x,
        y: ZONES.content.y,
        w: columnWidth,
        h: ZONES.content.h,
        valign: 'top'
      });

      slide.addText(rightText, {
        x: ZONES.content.x + columnWidth + LAYOUT.columnGap,
        y: ZONES.content.y,
        w: columnWidth,
        h: ZONES.content.h,
        valign: 'top'
      });
    }

    function createTableSlide(slide, data) {
      slide.addText(data.title, {
        ...ZONES.title,
        fontSize: 32,
        bold: true,
        color: '0066cc'
      });

      const sourceTable = data._normalizedTableData || data.tableData;

      if (
        !Array.isArray(sourceTable) ||
        sourceTable.length === 0 ||
        !Array.isArray(sourceTable[0]) ||
        sourceTable[0].length === 0
      ) {
        slide.addText('âš ï¸ Tableau indisponible\n\nStructure de donnÃ©es invalide dÃ©tectÃ©e.\nVÃ©rifiez que tableData commence par un tableau d\'en-tÃªtes non vide.', {
          x: ZONES.content.x,
          y: ZONES.content.y,
          w: ZONES.content.w,
          h: ZONES.content.h,
          fontSize: 18,
          color: 'C53030',
          align: 'center',
          valign: 'middle',
          fill: 'FFF5F5',
          border: { pt: 2, color: 'FC8181', type: 'dash' }
        });
        return;
      }

            // âœ… AMÃ‰LIORATION v2.0 : Utilisation de la normalisation sÃ©curisÃ©e
      let tableData;
      try {
        tableData = normalizeTableDataSafe(sourceTable);
      } catch (normError) {
        console.error("Erreur normalisation table:", normError);
        tableData = [["Erreur"], ["Impossible de normaliser les donnÃ©es"]];
      }

      const rowHeight = 0.35;
      const h = Math.min(ZONES.content.h, tableData.length * rowHeight);

      slide.addTable(tableData, {
        x: ZONES.content.x - LAYOUT.bulletIndent,
        y: ZONES.content.y,
        w: ZONES.content.w + LAYOUT.bulletIndent,
        h,
        border: { pt: 1, color: 'CFCFCF' },
        fontSize: 14,
        color: '333333',
        valign: 'middle',
        align: 'left'
      });
    }

    function createImageSlide(slide, data) {
      slide.addText(data.title, {
        ...ZONES.title,
        fontSize: 32,
        bold: true,
        color: '0066cc'
      });

      if (!data.imagePath) return;

      if (isDataUri(data.imagePath)) {
        slide.addImage({
          data: data.imagePath,
          x: ZONES.content.x,
          y: ZONES.content.y,
          w: ZONES.content.w,
          h: ZONES.content.h,
          sizing: {
            type: 'contain',
            w: ZONES.content.w,
            h: ZONES.content.h
          }
        });
      } else if (isPlaceholderUri(data.imagePath)) {
        const description = data.imagePath.replace('IMAGE_PLACEHOLDER_', '');
        slide.addText(`[IMAGE Ã€ INSÃ‰RER]\n\n${description}`, {
          x: ZONES.content.x,
          y: ZONES.content.y,
          w: ZONES.content.w,
          h: ZONES.content.h,
          fontSize: 18,
          color: '999999',
          align: 'center',
          valign: 'middle',
          fill: 'F5F5F5',
          border: { pt: 2, color: 'CCCCCC', type: 'dash' }
        });
      }
    }

    // ===== 4) GÃ‰NÃ‰RATION POWERPOINT (progressive + feedback dÃ©taillÃ©) =====
    async function generatePowerPoint() {
      const errorDiv = document.getElementById('error');
      const successDiv = document.getElementById('success');
      const warningDiv = document.getElementById('warning');
      const btn = document.getElementById('generateBtn');
      const spin = document.getElementById('genSpin');
      const label = document.getElementById('genLabel');

      const updateWarningPanel = (list = []) => {
        if (!warningDiv) return;
        if (!Array.isArray(list) || list.length === 0) {
          warningDiv.style.display = 'none';
          warningDiv.textContent = '';
        } else {
          warningDiv.textContent = 'âš ï¸ Avertissements :\n' + list.map(item => 'â€¢ ' + item).join('\n');
          warningDiv.style.display = 'block';
        }
      };

      if (errorDiv) {
        errorDiv.removeAttribute('data-autostatus');
        errorDiv.style.display = 'none';
        errorDiv.textContent = '';
      }
      if (successDiv) {
        successDiv.style.display = 'none';
        successDiv.textContent = '';
      }
      updateWarningPanel([]);

      let warningsToDisplay = [];

      try {
        const PptxGenJS = checkPptxGenAvailable();

        const jsonInputEl = document.getElementById('jsonInput');
        const jsonInput = jsonInputEl ? jsonInputEl.value.trim() : '';
        if (!jsonInput) {
          throw new Error('Veuillez coller du contenu JSON avant de gÃ©nÃ©rer');
        }

        let data;
        try {
          data = JSON.parse(jsonInput);
        } catch (e) {
          throw new Error('JSON invalide : ' + e.message);
        }

        const { errors, warns } = validateJSON(data);
        warningsToDisplay = Array.isArray(warns) ? warns.filter(Boolean) : [];

        if (errors.length) {
          throw new Error('Erreurs de validation :\n' + errors.map(e => 'â€¢ ' + e).join('\n'));
        }

        if (btn) btn.disabled = true;
        if (spin) spin.style.display = 'inline-block';
        if (label) label.textContent = 'PrÃ©paration de la prÃ©sentation...';

        const pptx = new PptxGenJS();
        pptx.author = data.metadata.author || 'Auteur';
        pptx.title = data.metadata.title || '';
        pptx.company = data.metadata.company || '';
        pptx.subject = data.metadata.subject || '';
        pptx.layout = 'LAYOUT_16x9';

        const totalSlides = data.slides.length;

        for (let i = 0; i < totalSlides; i++) {
          const slideData = data.slides[i];

          if (label) {
            label.textContent = `GÃ©nÃ©ration slide ${i + 1}/${totalSlides}...`;
          }

          await new Promise(resolve => setTimeout(resolve, 0));

          const slide = pptx.addSlide();
          switch (slideData.type) {
            case 'title':
              createTitleSlide(slide, slideData);
              break;
            case 'content':
              createContentSlide(slide, slideData);
              break;
            case 'twoColumn':
              createTwoColumnSlide(slide, slideData);
              break;
            case 'table':
              createTableSlide(slide, slideData);
              break;
            case 'image':
              createImageSlide(slide, slideData);
              break;
            default:
              throw new Error(`Type de slide inconnu Ã  l'index ${i}: "${slideData.type}"`);
          }
        }

        if (label) {
          label.textContent = 'Finalisation du fichier...';
        }
        await new Promise(resolve => setTimeout(resolve, 0));

        const fileName = data.metadata.fileName || `presentation-${Date.now()}.pptx`;
        await pptx.writeFile({ fileName });

        if (successDiv) {
          successDiv.textContent = `âœ“ PrÃ©sentation gÃ©nÃ©rÃ©e avec succÃ¨s : ${fileName}`;
          successDiv.style.display = 'block';
        }
        updateWarningPanel(warningsToDisplay);
      } catch (err) {
        if (errorDiv) {
          errorDiv.textContent = 'âŒ ' + err.message;
          errorDiv.style.display = 'block';
        }
        updateWarningPanel(warningsToDisplay);
        console.error('Erreur gÃ©nÃ©ration PowerPoint:', err);
      } finally {
        if (btn) {
          btn.disabled = false;
        }
        if (spin) {
          spin.style.display = 'none';
        }
        if (label) {
          label.textContent = 'ğŸš€ GÃ©nÃ©rer PowerPoint';
        }
      }
    }

    // ===== 5) UI : Prompt + AccordÃ©ons =====
    function togglePrompt() {
      const box = document.getElementById('promptBox');
      const txt = document.getElementById('promptText');
      if (box.style.display === 'none') { box.style.display = 'block'; txt.value = OPTIMAL_PROMPT; }
      else box.style.display = 'none';
    }
    async function copyPrompt() {
      const txt = document.getElementById('promptText');
      const fb = document.getElementById('copyFeedback');
      if (!txt || !fb) return;

      const defaultMessage = fb.dataset.defaultMessage || 'âœ“ Prompt copiÃ© dans le presse-papiers !';
      const fallbackMessage = 'Copie automatique indisponible. SÃ©lectionnez le texte puis utilisez Ctrl+C (Cmd+C sur Mac).';
      const showFeedback = (message, isError = false) => {
        fb.textContent = message;
        fb.style.color = isError ? '#c53030' : '#38a169';
        fb.style.display = 'block';
        clearTimeout(fb._timeoutId);
        fb._timeoutId = window.setTimeout(() => {
          fb.style.display = 'none';
          fb.style.color = '#38a169';
          fb.textContent = defaultMessage;
        }, 3000);
      };

      try {
        if (navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
          await navigator.clipboard.writeText(txt.value);
          showFeedback(defaultMessage);
          return;
        }
      } catch (err) {
        // Continuer vers les mÃ©canismes de secours
      }

      try {
        txt.focus();
        txt.select();
        if (typeof txt.setSelectionRange === 'function') {
          txt.setSelectionRange(0, txt.value.length);
        }
        const successful = document.execCommand && document.execCommand('copy');
        if (successful) {
          showFeedback(defaultMessage);
        } else {
          throw new Error('execCommand copy unsuccessful');
        }
      } catch (err) {
        txt.focus();
        txt.select();
        if (typeof txt.setSelectionRange === 'function') {
          txt.setSelectionRange(0, txt.value.length);
        }
        showFeedback(fallbackMessage, true);
      }
    }
    function toggleCollapsible(header) {
      const content = header.nextElementSibling; const arrow = header.querySelector('span:last-child');
      content.classList.toggle('active'); arrow.textContent = content.classList.contains('active') ? 'â–²' : 'â–¼';
    }

    // ===== 6) PROMPT OPTIMAL (corrigÃ© & alignÃ©) =====
    const OPTIMAL_PROMPT = (() => {
      const promptNode = document.getElementById('optimalPromptV2');
      if (promptNode && typeof promptNode.textContent === 'string') {
        return promptNode.textContent.trim();
      }
      return "Prompt optimal indisponible : vÃ©rifiez la balise #optimalPromptV2.";
    })();

  document.addEventListener('DOMContentLoaded', () => {
    const errorDiv = document.getElementById('error');
    const generateBtn = document.getElementById('generateBtn');
    let pollId = null;
    let hasLoggedTimeout = false;
    const startTime = Date.now();

    const clearAutoStatus = () => {
      if (errorDiv && errorDiv.dataset.autostatus === 'pptx-missing') {
        errorDiv.style.display = 'none';
        errorDiv.textContent = '';
        delete errorDiv.dataset.autostatus;
      }
    };

    const enableGenerator = () => {
      if (generateBtn) {
        generateBtn.disabled = false;
        generateBtn.removeAttribute('aria-disabled');
      }
      clearAutoStatus();
    };

    const attempt = () => {
      try {
        checkPptxGenAvailable();
        enableGenerator();
        if (pollId) {
          clearInterval(pollId);
          pollId = null;
        }
        return true;
      } catch (err) {
        if (generateBtn) {
          generateBtn.disabled = true;
          generateBtn.setAttribute('aria-disabled', 'true');
        }
        const elapsed = Date.now() - startTime;
        const message = elapsed > 5000
          ? 'âŒ BibliothÃ¨que PptxGenJS non dÃ©tectÃ©e. VÃ©rifiez que "pptxgen.bundle.js" est prÃ©sent localement et rechargez la page.'
          : 'â„¹ï¸ Chargement de la bibliothÃ¨que PptxGenJS...';
        if (errorDiv) {
          errorDiv.textContent = message;
          errorDiv.style.display = 'block';
          errorDiv.dataset.autostatus = 'pptx-missing';
        }
        if (elapsed > 15000 && pollId) {
          clearInterval(pollId);
          pollId = null;
          if (!hasLoggedTimeout) {
            console.error(err);
            hasLoggedTimeout = true;
          }
        }
        return false;
      }
    };

    if (!attempt()) {
      pollId = setInterval(() => {
        if (attempt()) {
          if (pollId) {
            clearInterval(pollId);
            pollId = null;
          }
          return;
        }
        if (Date.now() - startTime > 15000 && pollId) {
          clearInterval(pollId);
          pollId = null;
        }
      }, 300);
    }
  });
  </script>
</body>
</html>
